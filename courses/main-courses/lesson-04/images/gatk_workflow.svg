<?xml version="1.0" encoding="UTF-8"?>
<svg width="800" height="700" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: 'Source Han Sans CN', sans-serif; font-size: 18px; font-weight: bold; fill: #1e3a8a; }
      .subtitle { font-family: 'Source Han Sans CN', sans-serif; font-size: 14px; font-weight: bold; fill: #374151; }
      .text { font-family: 'Source Han Sans CN', sans-serif; font-size: 12px; fill: #4b5563; }
      .step-text { font-family: 'Source Han Sans CN', sans-serif; font-size: 11px; fill: white; font-weight: bold; }
      .detail-text { font-family: 'Source Han Sans CN', sans-serif; font-size: 10px; fill: #6b7280; }
      .command { font-family: 'Courier New', monospace; font-size: 9px; fill: #374151; }
    </style>
  </defs>
  
  <!-- 标题 -->
  <text x="400" y="30" text-anchor="middle" class="title">GATK最佳实践流程</text>
  
  <!-- 输入数据 -->
  <g transform="translate(50, 60)">
    <rect x="0" y="0" width="100" height="40" rx="5" fill="#6b7280" stroke="#4b5563"/>
    <text x="50" y="25" text-anchor="middle" class="step-text">原始BAM</text>
    <text x="110" y="25" class="detail-text">已比对的测序数据</text>
  </g>
  
  <!-- 箭头 -->
  <path d="M 100 100 L 100 130" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- 步骤1: 重复序列标记 -->
  <g transform="translate(50, 140)">
    <rect x="0" y="0" width="150" height="50" rx="8" fill="#3b82f6" stroke="#1d4ed8"/>
    <text x="75" y="20" text-anchor="middle" class="step-text">1. 标记重复序列</text>
    <text x="75" y="35" text-anchor="middle" class="step-text">MarkDuplicates</text>
    
    <!-- 命令 -->
    <text x="0" y="70" class="command">gatk MarkDuplicates -I input.bam -O marked.bam -M metrics.txt</text>
    
    <!-- 说明 -->
    <text x="210" y="20" class="detail-text">• 识别PCR重复</text>
    <text x="210" y="35" class="detail-text">• 标记但不删除</text>
    <text x="210" y="50" class="detail-text">• 生成统计报告</text>
  </g>
  
  <!-- 箭头 -->
  <path d="M 125 190 L 125 220" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- 步骤2: 碱基质量校正 -->
  <g transform="translate(50, 230)">
    <rect x="0" y="0" width="150" height="50" rx="8" fill="#059669" stroke="#047857"/>
    <text x="75" y="20" text-anchor="middle" class="step-text">2. 碱基质量校正</text>
    <text x="75" y="35" text-anchor="middle" class="step-text">BQSR</text>
    
    <!-- 命令 -->
    <text x="0" y="70" class="command">gatk BaseRecalibrator -I marked.bam -R ref.fa --known-sites dbsnp.vcf -O recal.table</text>
    <text x="0" y="85" class="command">gatk ApplyBQSR -I marked.bam -R ref.fa --bqsr-recal-file recal.table -O recal.bam</text>
    
    <!-- 说明 -->
    <text x="210" y="20" class="detail-text">• 系统性错误校正</text>
    <text x="210" y="35" class="detail-text">• 使用已知变异位点</text>
    <text x="210" y="50" class="detail-text">• 提高变异检测精度</text>
  </g>
  
  <!-- 箭头 -->
  <path d="M 125 315 L 125 345" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- 步骤3: 变异检测 -->
  <g transform="translate(50, 355)">
    <rect x="0" y="0" width="150" height="50" rx="8" fill="#dc2626" stroke="#b91c1c"/>
    <text x="75" y="20" text-anchor="middle" class="step-text">3. 变异检测</text>
    <text x="75" y="35" text-anchor="middle" class="step-text">HaplotypeCaller</text>
    
    <!-- 命令 -->
    <text x="0" y="70" class="command">gatk HaplotypeCaller -I recal.bam -R ref.fa -O variants.g.vcf -ERC GVCF</text>
    
    <!-- 说明 -->
    <text x="210" y="20" class="detail-text">• 基于单倍型检测</text>
    <text x="210" y="35" class="detail-text">• 生成GVCF文件</text>
    <text x="210" y="50" class="detail-text">• 同时检测SNP和InDel</text>
  </g>
  
  <!-- 分支：单样本 vs 多样本 -->
  <g transform="translate(300, 355)">
    <!-- 单样本路径 -->
    <path d="M 0 25 L 50 25" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="25" y="20" text-anchor="middle" class="detail-text">单样本</text>
    
    <rect x="60" y="0" width="120" height="50" rx="8" fill="#7c3aed" stroke="#5b21b6"/>
    <text x="120" y="20" text-anchor="middle" class="step-text">直接基因分型</text>
    <text x="120" y="35" text-anchor="middle" class="step-text">GenotypeGVCFs</text>
    
    <!-- 多样本路径 -->
    <path d="M 0 25 L 25 50 L 50 75" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
    <text x="40" y="95" text-anchor="middle" class="detail-text">多样本</text>
    
    <rect x="60" y="75" width="120" height="50" rx="8" fill="#f59e0b" stroke="#d97706"/>
    <text x="120" y="95" text-anchor="middle" class="step-text">联合基因分型</text>
    <text x="120" y="110" text-anchor="middle" class="step-text">CombineGVCFs</text>
  </g>
  
  <!-- 箭头汇聚 -->
  <path d="M 420 25 L 450 25 L 450 50 L 480 50" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
  <path d="M 420 100 L 450 100 L 450 75 L 480 75" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
  
  <!-- 步骤4: 变异质量校正 -->
  <g transform="translate(490, 355)">
    <rect x="0" y="0" width="150" height="50" rx="8" fill="#10b981" stroke="#059669"/>
    <text x="75" y="20" text-anchor="middle" class="step-text">4. 变异质量校正</text>
    <text x="75" y="35" text-anchor="middle" class="step-text">VQSR</text>

    <!-- 命令 -->
    <text x="0" y="70" class="command">gatk VariantRecalibrator -V raw.vcf -R ref.fa --resource hapmap.vcf</text>
    <text x="0" y="85" class="command">gatk ApplyVQSR -V raw.vcf --recal-file snp.recal -O filtered.vcf</text>

    <!-- 说明 -->
    <text x="0" y="110" class="detail-text">• 机器学习质量评估</text>
    <text x="0" y="125" class="detail-text">• 使用高质量训练集</text>
    <text x="0" y="140" class="detail-text">• 软过滤方法</text>
  </g>
  
  <!-- VQSR详细流程 -->
  <g transform="translate(50, 520)">
    <text x="0" y="0" class="subtitle">VQSR详细流程</text>
    
    <!-- 训练数据 -->
    <rect x="0" y="20" width="100" height="30" rx="5" fill="#6366f1" stroke="#4f46e5"/>
    <text x="50" y="40" text-anchor="middle" class="step-text" font-size="10">训练数据集</text>
    
    <text x="0" y="65" class="detail-text">• HapMap (高质量SNP)</text>
    <text x="0" y="80" class="detail-text">• 1000 Genomes (真实变异)</text>
    <text x="0" y="95" class="detail-text">• dbSNP (已知变异)</text>
    <text x="0" y="110" class="detail-text">• Mills InDel (高质量InDel)</text>
    
    <!-- 箭头 -->
    <path d="M 110 35 L 140 35" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- 特征提取 -->
    <rect x="150" y="20" width="100" height="30" rx="5" fill="#059669" stroke="#047857"/>
    <text x="200" y="40" text-anchor="middle" class="step-text" font-size="10">特征提取</text>
    
    <text x="150" y="65" class="detail-text">• QD (质量/深度)</text>
    <text x="150" y="80" class="detail-text">• MQ (比对质量)</text>
    <text x="150" y="95" class="detail-text">• FS (Fisher链偏倚)</text>
    <text x="150" y="110" class="detail-text">• SOR (链偏倚比值)</text>
    
    <!-- 箭头 -->
    <path d="M 260 35 L 290 35" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- 模型训练 -->
    <rect x="300" y="20" width="100" height="30" rx="5" fill="#dc2626" stroke="#b91c1c"/>
    <text x="350" y="40" text-anchor="middle" class="step-text" font-size="10">模型训练</text>
    
    <text x="300" y="65" class="detail-text">• 高斯混合模型</text>
    <text x="300" y="80" class="detail-text">• 变异质量评分</text>
    <text x="300" y="95" class="detail-text">• 敏感性阈值</text>
    
    <!-- 箭头 -->
    <path d="M 410 35 L 440 35" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
    
    <!-- 质量过滤 -->
    <rect x="450" y="20" width="100" height="30" rx="5" fill="#f59e0b" stroke="#d97706"/>
    <text x="500" y="40" text-anchor="middle" class="step-text" font-size="10">质量过滤</text>
    
    <text x="450" y="65" class="detail-text">• VQSLOD评分</text>
    <text x="450" y="80" class="detail-text">• 敏感性水平</text>
    <text x="450" y="95" class="detail-text">• PASS/FILTER标记</text>
  </g>
  
  <!-- 硬过滤替代方案 -->
  <g transform="translate(400, 520)">
    <text x="0" y="0" class="subtitle">硬过滤标准 (VQSR替代方案)</text>
    
    <rect x="0" y="20" width="350" height="120" fill="#f9fafb" stroke="#e5e7eb" rx="5"/>
    
    <!-- SNP过滤 -->
    <text x="20" y="40" class="text" font-weight="bold">SNP过滤标准:</text>
    <text x="20" y="55" class="detail-text">• QD &lt; 2.0 (质量密度过低)</text>
    <text x="20" y="70" class="detail-text">• MQ &lt; 40.0 (比对质量过低)</text>
    <text x="20" y="85" class="detail-text">• FS &gt; 60.0 (Fisher链偏倚过高)</text>
    <text x="20" y="100" class="detail-text">• SOR &gt; 3.0 (链偏倚比值过高)</text>
    <text x="20" y="115" class="detail-text">• MQRankSum &lt; -12.5 (比对质量偏倚)</text>
    <text x="20" y="130" class="detail-text">• ReadPosRankSum &lt; -8.0 (位置偏倚)</text>
    
    <!-- InDel过滤 -->
    <text x="200" y="40" class="text" font-weight="bold">InDel过滤标准:</text>
    <text x="200" y="55" class="detail-text">• QD &lt; 2.0</text>
    <text x="200" y="70" class="detail-text">• FS &gt; 200.0</text>
    <text x="200" y="85" class="detail-text">• SOR &gt; 10.0</text>
    <text x="200" y="100" class="detail-text">• ReadPosRankSum &lt; -20.0</text>
  </g>
  
  <!-- 箭头标记定义 -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
    </marker>
  </defs>
</svg>